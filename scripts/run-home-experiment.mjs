import fs from 'node:fs';
import path from 'node:path';

const experiment = (process.argv[2] || '').toUpperCase();
const outputPath = path.resolve(process.cwd(), process.argv[3] || '.env.experiment.local');

if (!['A', 'B'].includes(experiment)) {
  console.error('Usage: node scripts/run-home-experiment.mjs <A|B> [outputEnvFile]');
  process.exit(1);
}

const presets = {
  A: {
    NEXT_PUBLIC_HOME_EXPERIMENT_ID: 'home_discovery_exp_a',
    NEXT_PUBLIC_HOME_EXPERIMENT_VARIANTS: 'control,intent_first',
    NEXT_PUBLIC_HOME_EXPERIMENT_BASELINE_VARIANT: 'control',
    NEXT_PUBLIC_HOME_EXPERIMENT_CANARY_PERCENT: '100'
  },
  B: {
    NEXT_PUBLIC_HOME_EXPERIMENT_ID: 'home_discovery_exp_b',
    NEXT_PUBLIC_HOME_EXPERIMENT_VARIANTS: 'rails_only,rails_assistant',
    NEXT_PUBLIC_HOME_EXPERIMENT_BASELINE_VARIANT: 'rails_only',
    NEXT_PUBLIC_HOME_EXPERIMENT_CANARY_PERCENT: '100'
  }
};

const selected = presets[experiment];

const lines = [
  '# Auto-generated by scripts/run-home-experiment.mjs',
  ...Object.entries(selected).map(([key, value]) => `${key}=${value}`)
];

fs.writeFileSync(outputPath, `${lines.join('\n')}\n`);

console.log(`Experiment ${experiment} preset written to ${outputPath}`);
console.log('Apply with:');
console.log(`  cp ${path.basename(outputPath)} .env.local`);
console.log('Then run: npm run dev');
